<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–£—á–µ–±–Ω—ã–π —á–∞—Ç-–±–æ—Ç ‚Äî –ú–∏—Ä–æ–≤–∞—è –∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#1f2937;       /* gray-800 */
      --text:#e5e7eb;        /* gray-200 */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#a78bfa;    /* violet-400 */
      --danger:#ef4444;      /* red-500 */
      --ok:#10b981;          /* emerald-500 */
      --shadow: 0 10px 30px rgba(0,0,0,.3);
    }
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(120deg,#0b1220,#0f172a 30%,#0b1220);
      color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{width:min(1100px,100%); height:min(760px,100%); display:grid; grid-template-columns:320px 1fr; gap:16px}
    .card{background:rgba(17,24,39,.85); backdrop-filter: blur(8px); border:1px solid #192032; border-radius:20px; box-shadow:var(--shadow)}
    .sidebar{padding:16px; display:flex; flex-direction:column}
    .brand{display:flex; align-items:center; gap:10px; padding:8px 10px 16px}
    .logo{width:34px; height:34px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 6px 20px rgba(34,211,238,.35)}
    .brand h1{font-size:16px; font-weight:700; letter-spacing:.2px; margin:0}
    .brand small{opacity:.7}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 14px; max-height:150px; overflow:auto}
    .chip{border:1px solid #243042; padding:6px 10px; border-radius:999px; cursor:pointer; font-size:12px}
    .chip:hover{border-color:var(--accent); color:var(--accent)}
    .panel{background:var(--muted); border-radius:14px; padding:10px; margin-top:auto}
    .panel h3{margin:0 0 10px; font-size:12px; opacity:.8; font-weight:600}
    .panel .row{display:flex; gap:8px; margin:8px 0; align-items:center}
    .panel label{font-size:12px; opacity:.9}
    .panel input[type="checkbox"]{accent-color:var(--accent)}

    .main{display:grid; grid-template-rows:auto 1fr auto; overflow:hidden}
    .header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #1d2636}
    .header .title{display:flex; align-items:center; gap:10px}
    .status{font-size:12px; opacity:.7}

    .feed{padding:18px; overflow:auto; display:flex; flex-direction:column; gap:14px}
    .msg{display:flex; gap:10px; align-items:flex-start}
    .avatar{flex:0 0 36px; width:36px; height:36px; border-radius:12px; background:#0b1325; display:grid; place-items:center; border:1px solid #1e2a3c}
    .avatar.bot{background:linear-gradient(160deg, rgba(34,211,238,.15), rgba(167,139,250,.15)); color:var(--accent)}
    .bubble{max-width:70%; padding:12px 14px; border:1px solid #223048; border-radius:14px; line-height:1.5}
    .bubble.bot{background:rgba(34,211,238,.08)}
    .bubble.user{background:rgba(167,139,250,.08)}
    .meta{font-size:11px; opacity:.6; margin-top:6px}

    .typing{display:inline-block; width:36px; height:10px}
    .typing span{display:inline-block; width:6px; height:6px; margin-right:4px; background:#60708f; border-radius:50%; animation:blink 1s infinite ease-in-out}
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2; transform:translateY(0)}40%{opacity:1; transform:translateY(-2px)}}

    .composer{display:flex; gap:10px; padding:14px; border-top:1px solid #1d2636}
    .composer input{flex:1; background:#0b1320; border:1px solid #1d2636; border-radius:12px; padding:14px; color:var(--text); outline:none}
    .composer input:focus{border-color:#2b3a55; box-shadow:0 0 0 3px rgba(34,211,238,.08)}
    .btn{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#081120; border:none; padding:12px 14px; border-radius:12px; font-weight:700; cursor:pointer}
    .ghost{background:transparent; border:1px solid #263143; color:var(--text)}
    .toolbar{display:flex; gap:8px}

    .kbd{border:1px solid #2b3a55; background:#0c1526; padding:2px 6px; border-radius:6px; font-size:11px}
    .hint{font-size:12px; opacity:.75; padding:0 16px 12px}

    .notice{border-left:3px solid var(--accent); background:rgba(34,211,238,.07); padding:10px 12px; border-radius:12px; font-size:13px}
    .success{border-left-color:var(--ok); background:rgba(16,185,129,.07)}
    .danger{border-left-color:var(--danger); background:rgba(239,68,68,.07)}

    .optrow{display:flex; gap:8px; flex-wrap:wrap}
    .opt{border:1px dashed #2a3750; border-radius:10px; padding:8px 10px; font-size:12px; cursor:pointer}
    .opt:hover{border-color:var(--accent)}

    .code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#0a1120; padding:8px 10px; border-radius:8px; border:1px solid #1e2a3c; overflow:auto}

    .footer-links{font-size:11px; opacity:.65; text-align:center; margin-top:8px}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar card">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>–ö—É–ª—å—Ç—É—Ä–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫</h1>
          <small>–ú–∏—Ä–æ–≤–∞—è –∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞</small>
        </div>
      </div>

      <div class="notice" id="narrowing">
        –ú–æ–∂–Ω–æ —Å—É–∑–∏—Ç—å —Ç–µ–º—É. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ <span class="kbd">/topic</span> –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ.
      </div>

      <h3 style="margin:14px 10px 4px; opacity:.85">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</h3>
      <div class="chips" id="chips"></div>

      <div class="panel">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–∞–ª–æ–≥–∞</h3>
        <div class="row"><input type="checkbox" id="cbSocratic"/><label for="cbSocratic">–°–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º (–±–æ–ª—å—à–µ –≤–æ–ø—Ä–æ—Å–æ–≤)</label></div>
        <div class="row"><input type="checkbox" id="cbTutor"/><label for="cbTutor">–†–µ–∂–∏–º –£—á–∏—Ç–µ–ª—è (–ø–æ—è—Å–Ω–µ–Ω–∏—è + –º–∏–Ω–∏‚Äë–∑–∞–¥–∞–Ω–∏—è)</label></div>
        <div class="row"><input type="checkbox" id="cbQuiz"/><label for="cbQuiz">–í–∫–ª—é—á–∏—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã –ø–æ —Ç–µ–º–µ</label></div>
      </div>

      <div class="footer-links">
        –ü–æ–¥—Å–∫–∞–∑–∫–∏: <span class="kbd">/help</span> <span class="kbd">/mode</span> <span class="kbd">/quiz</span> <span class="kbd">/reset</span>
      </div>
    </aside>

    <section class="main card">
      <div class="header">
        <div class="title">
          <div class="avatar bot">üé≠</div>
          <div>
            <div style="font-weight:700">–ö—É–ª—å—Ç—É—Ä–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫</div>
            <div class="status" id="status">–ì–æ—Ç–æ–≤ –∫ –±–µ—Å–µ–¥–µ</div>
          </div>
        </div>
        <div class="toolbar">
          <button class="btn ghost" id="btnExport" title="–°–∫–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ –∫–∞–∫ TXT">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <button class="btn ghost" id="btnReset" title="–û—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <div class="feed" id="feed" role="log" aria-live="polite"></div>
      <div class="hint">–ù–∞–∂–º–∏—Ç–µ <span class="kbd">Enter</span> –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, <span class="kbd">Shift+Enter</span> ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞.</div>

      <div class="composer">
        <input id="input" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ –æ –†–µ–Ω–µ—Å—Å–∞–Ω—Å–µ, –∞–≤–∞–Ω–≥–∞—Ä–¥–µ, —Ç–µ–∞—Ç—Ä–µ –ù–æ, –ú–æ—Ü–∞—Ä—Ç–µ, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–µ‚Ä¶ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (/help)"/>
        <button class="btn" id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </section>
  </div>

<script>
// ------------------- –ú–ò–ù–ò-–Ø–î–†–û –ß–ê–¢-–ë–û–¢–ê -------------------
(function(){
  const feed = document.getElementById('feed');
  const input = document.getElementById('input');
  const sendBtn = document.getElementById('send');
  const statusEl = document.getElementById('status');
  const chipsEl = document.getElementById('chips');
  const btnExport = document.getElementById('btnExport');
  const btnReset = document.getElementById('btnReset');
  const cbSocratic = document.getElementById('cbSocratic');
  const cbTutor = document.getElementById('cbTutor');
  const cbQuiz = document.getElementById('cbQuiz');

  // –¢–µ–º—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ (–º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω—è—Ç—å)
  const TOPICS = [
    '–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å', '–°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ', '–†–µ–Ω–µ—Å—Å–∞–Ω—Å', '–ë–∞—Ä–æ–∫–∫–æ', '–ö–ª–∞—Å—Å–∏—Ü–∏–∑–º', '–†–æ–º–∞–Ω—Ç–∏–∑–º', '–†–µ–∞–ª–∏–∑–º', '–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º', '–ú–æ–¥–µ—Ä–Ω/–ê—Ä –ù—É–≤–æ', '–ê–≤–∞–Ω–≥–∞—Ä–¥', '–ë–∞—É—Ö–∞—É–∑', '–°—é—Ä—Ä–µ–∞–ª–∏–∑–º', '–≠–∫—Å–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º', '–ü–æ—Å—Ç–º–æ–¥–µ—Ä–Ω–∏–∑–º', '–ú—É–∑—ã–∫–∞', '–¢–µ–∞—Ç—Ä', '–ö–∏–Ω–æ', '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞', '–ñ–∏–≤–æ–ø–∏—Å—å', '–°–∫—É–ª—å–ø—Ç—É—Ä–∞', '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ñ–æ–ª–æ–≥–∏—è', '–†–µ–ª–∏–≥–∏–æ–∑–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ', '–ù–∞—Ä–æ–¥—ã –∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏', '–Ø–ø–æ–Ω–∏—è', '–ò–Ω–¥–∏—è', '–ö–∏—Ç–∞–π', '–ê—Ñ—Ä–∏–∫–∞', '–õ–∞—Ç–∏–Ω—Å–∫–∞—è –ê–º–µ—Ä–∏–∫–∞'
  ];

  // –ù–µ–±–æ–ª—å—à–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π (–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ -> –æ—Ç–≤–µ—Ç—ã/—Ñ–∞–∫—Ç—ã/–≤–æ–ø—Ä–æ—Å—ã)
  const KB = [
    {topic:'–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å', keywords:['–¥—Ä–µ–≤–Ω—è—è –≥—Ä–µ—Ü–∏—è','–∞–Ω—Ç–∏—á–Ω–æ—Å—Ç—å','—Ä–∏–º','—ç–ª–ª–∞–¥–∞','–æ–ª–∏–º–ø'], facts:[
      '–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –ø–æ–¥–∞—Ä–∏–ª–∞ –∫–∞–Ω–æ–Ω –ø—Ä–æ–ø–æ—Ä—Ü–∏–π (–ü–æ–ª–∏–∫–ª–µ—Ç) –∏ –∏–¥–µ–∞–ª –≥–∞—Ä–º–æ–Ω–∏–∏ —Ç–µ–ª–∞.',
      '–ü–∞—Ä—Ñ–µ–Ω–æ–Ω –≤ –ê—Ñ–∏–Ω–∞—Ö ‚Äî –æ–±—Ä–∞–∑–µ—Ü –¥–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –æ—Ä–¥–µ—Ä–∞.',
      '–†–∏–º–ª—è–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –±–µ—Ç–æ–Ω –∏ –∞—Ä–∫—É, —á—Ç–æ –ø–æ–∑–≤–æ–ª–∏–ª–æ –≤–æ–∑–≤–æ–¥–∏—Ç—å –∫—É–ø–æ–ª—å–Ω—ã–µ —Å–æ–æ—Ä—É–∂–µ–Ω–∏—è.'
    ], prompts:[
      '–ß–µ–º –¥–æ—Ä–∏—á–µ—Å–∫–∏–π –æ—Ä–¥–µ—Ä –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∏–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ?',
      '–ö–∞–∫–∏–µ —Å—é–∂–µ—Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤ –≥—Ä–µ—á–µ—Å–∫–æ–π –≤–∞–∑–æ–ø–∏—Å–∏?',
      '–ö–∞–∫ —Ä–∏–º—Å–∫–∏–π –ü–∞–Ω—Ç–µ–æ–Ω –ø–æ–≤–ª–∏—è–ª –Ω–∞ –µ–≤—Ä–æ–ø–µ–π—Å–∫—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É?'
    ]},
    {topic:'–†–µ–Ω–µ—Å—Å–∞–Ω—Å', keywords:['—Ä–µ–Ω–µ—Å—Å–∞–Ω—Å','–≤–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ','–ª–µ–æ–Ω–∞—Ä–¥–æ','–º–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ','—Ä–∞—Ñ–∞—ç–ª—å','–±–æ—Ç—Ç–∏—á–µ–ª–ª–∏','–º–∞–¥–æ–Ω–Ω–∞','—Ñ–ª–æ—Ä–µ–Ω—Ü–∏—è'], facts:[
      '–†–µ–Ω–µ—Å—Å–∞–Ω—Å –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ –≥—É–º–∞–Ω–∏–∑–º –∏ –∏–Ω—Ç–µ—Ä–µ—Å –∫ –∞–Ω—Ç–∏—á–Ω–æ–º—É –Ω–∞—Å–ª–µ–¥–∏—é.',
      '–õ–∏–Ω–µ–π–Ω–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ (–ë—Ä—É–Ω–µ–ª–ª–µ—Å–∫–∏, –ê–ª—å–±–µ—Ä—Ç–∏) –∏–∑–º–µ–Ω–∏–ª–∞ —Å–ø–æ—Å–æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.',
      '–í—ã—Å–æ–∫–∏–π –†–µ–Ω–µ—Å—Å–∞–Ω—Å ‚Äî –õ–µ–æ–Ω–∞—Ä–¥–æ, –ú–∏–∫–µ–ª–∞–Ω–¥–∂–µ–ª–æ, –†–∞—Ñ–∞—ç–ª—å ‚Äî –æ–∫–æ–ª–æ 1490‚Äì1520 –≥–æ–¥–æ–≤.'
    ], prompts:[
      '–ö–∞–∫–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏—ë–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –õ–µ–æ–Ω–∞—Ä–¥–æ –≤ ¬´–¢–∞–π–Ω–æ–π –≤–µ—á–µ—Ä–µ¬ª?',
      '–ü–æ—á–µ–º—É ¬´–í–µ—Å–Ω–∞¬ª –ë–æ—Ç—Ç–∏—á–µ–ª–ª–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–ª–ª–µ–≥–æ—Ä–∏–µ–π?',
      '–ß–µ–º —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è —Ñ–ª–æ—Ä–µ–Ω—Ç–∏–π—Å–∫–∞—è –∏ –≤–µ–Ω–µ—Ü–∏–∞–Ω—Å–∫–∞—è —à–∫–æ–ª—ã?'
    ]},
    {topic:'–ë–∞—Ä–æ–∫–∫–æ', keywords:['–±–∞—Ä–æ–∫–∫–æ','–±–µ—Ä–Ω–∏–Ω–∏','–∫–∞—Ä–∞–≤–∞–¥–∂–æ','–∫–æ–Ω—Ç—Ä–∞—Å—Ç','—Ç–µ–∞—Ç—Ä —Å–≤–µ—Ç–∞'], facts:[
      '–ë–∞—Ä–æ–∫–∫–æ –ª—é–±–∏—Ç –¥—Ä–∞–º—É, –¥–≤–∏–∂–µ–Ω–∏–µ –∏ –∫–æ–Ω—Ç—Ä–∞—Å—Ç —Å–≤–µ—Ç–∞ –∏ —Ç–µ–Ω–∏ (–∫—å—è—Ä–æ—Å–∫—É—Ä–æ).',
      '–í –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ ‚Äî –¥–∏–Ω–∞–º–∏—á–Ω—ã–µ —Ñ–∞—Å–∞–¥—ã, –æ–≤–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã, –±–æ–≥–∞—Ç—ã–π –¥–µ–∫–æ—Ä.',
      '–ë–µ—Ä–Ω–∏–Ω–∏ –≤ —Å–∫—É–ª—å–ø—Ç—É—Ä–µ —Å–æ—á–µ—Ç–∞–µ—Ç —Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—É—é –ø–ª–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å.'
    ], prompts:['–ß–µ–º –±–∞—Ä–æ–∫–∫–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∫–ª–∞—Å—Å–∏—Ü–∏–∑–º–∞?','–ö–∞–∫–∏–µ –ø—Ä–∏—ë–º—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ö–∞—Ä–∞–≤–∞–¥–∂–æ –¥–ª—è –¥—Ä–∞–º–∞—Ç–∏–∑–º–∞?']},
    {topic:'–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º', keywords:['–∏–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º','–º–æ–Ω—ç','–¥–µ–≥–∞','—Ä–µ–Ω—É–∞—Ä','–ø–ª–µ–Ω—ç—Ä','–º–æ–º–µ–Ω—Ç'], facts:[
      '–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏—Å—Ç—ã –ø–∏—Å–∞–ª–∏ –Ω–∞ –ø–ª–µ–Ω—ç—Ä–µ, —Ñ–∏–∫—Å–∏—Ä—É—è –∏–∑–º–µ–Ω—á–∏–≤—ã–π —Å–≤–µ—Ç –∏ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è.',
      '–û—Ç–∫–∞–∑ –æ—Ç —á—ë—Ç–∫–∏—Ö –∫–æ–Ω—Ç—É—Ä–æ–≤, –¥—Ä–æ–±–Ω—ã–π –º–∞–∑–æ–∫, —á–∏—Å—Ç—ã–µ —Ü–≤–µ—Ç–∞ ‚Äî —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏.'
    ], prompts:['–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏–∫–∏ —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ä–≥–∞–ª–∏ –∏–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏—Å—Ç–æ–≤?','–ö–∞–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø–æ–≤–ª–∏—è–ª–∞ –Ω–∞ –∏–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º?']},
    {topic:'–ê–≤–∞–Ω–≥–∞—Ä–¥', keywords:['–∞–≤–∞–Ω–≥–∞—Ä–¥','–∫—É–±–∏–∑–º','—Ñ—É—Ç—É—Ä–∏–∑–º','—Å—É–ø—Ä–µ–º–∞—Ç–∏–∑–º','–¥–∞–¥–∞','–∫–∞–Ω–¥–∏–Ω—Å–∫–∏–π','–º–æ–Ω–¥—Ä–∏–∞–Ω','–º–∞–ª–µ–≤–∏—á'], facts:[
      '–ê–≤–∞–Ω–≥–∞—Ä–¥ –∏—Å—Å–ª–µ–¥—É–µ—Ç —Ñ–æ—Ä–º—É –∏ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—é, –æ—Ç–≤–µ—Ä–≥–∞—è —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—É—é –º–∏–º–µ—Å–∏—Å.',
      '–ö—É–±–∏–∑–º —Ä–∞–∑–ª–∞–≥–∞–µ—Ç –ø—Ä–µ–¥–º–µ—Ç –Ω–∞ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–µ –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞–∫—É—Ä—Å—ã.',
      '–°—É–ø—Ä–µ–º–∞—Ç–∏–∑–º –ú–∞–ª–µ–≤–∏—á–∞ ‚Äî ¬´—á–∏—Å—Ç–æ–µ —á—É–≤—Å—Ç–≤–æ¬ª —á–µ—Ä–µ–∑ –±–∞–∑–æ–≤—ã–µ —Ñ–æ—Ä–º—ã –∏ —Ü–≤–µ—Ç.'
    ], prompts:['–í —á—ë–º —Ä–∞–∑–ª–∏—á–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏ —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫—É–±–∏–∑–º–∞?','–ö–∞–∫–∏–µ –∏–¥–µ–∏ –¥–∞–¥–∞–∏—Å—Ç–æ–≤ –ø–æ–≤–ª–∏—è–ª–∏ –Ω–∞ –ø–æ—Å—Ç–º–æ–¥–µ—Ä–Ω–∏–∑–º?']},
    {topic:'–ú—É–∑—ã–∫–∞', keywords:['–º—É–∑—ã–∫–∞','–º–æ—Ü–∞—Ä—Ç','–±–∞—Ö','–±–µ—Ç—Ö–æ–≤–µ–Ω','–¥–∂–∞–∑','—Å–∏–º—Ñ–æ–Ω–∏—è','–æ–ø–µ—Ä–∞','—Å–æ–Ω–∞—Ç–∞'], facts:[
      '–ö–ª–∞—Å—Å–∏—Ü–∏–∑–º –≤ –º—É–∑—ã–∫–µ ‚Äî —è—Å–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º (—Å–æ–Ω–∞—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞), –±–∞–ª–∞–Ω—Å –∏ —Å–∏–º–º–µ—Ç—Ä–∏—è.',
      '–ë–∞—Ö ‚Äî –ø–æ–ª–∏—Ñ–æ–Ω–∏—è –±–∞—Ä–æ–∫–∫–æ; –ë–µ—Ç—Ö–æ–≤–µ–Ω ‚Äî —Ä—É–±–µ–∂ –∫–ª–∞—Å—Å–∏—Ü–∏–∑–º–∞ –∏ —Ä–æ–º–∞–Ω—Ç–∏–∑–º–∞.',
      '–î–∂–∞–∑ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª—Å—è –≤ –Ω–∞—á–∞–ª–µ XX –≤–µ–∫–∞, –∏–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏—è ‚Äî –µ–≥–æ –∫–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø.'
    ], prompts:['–ß–µ–º –æ–ø–µ—Ä–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –æ–ø–µ—Ä–µ—Ç—Ç—ã?','–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Å–æ–Ω–∞—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞?']},
    {topic:'–¢–µ–∞—Ç—Ä', keywords:['—Ç–µ–∞—Ç—Ä','—à–µ–∫—Å–ø–∏—Ä','—Å—Ç–∞–Ω–∏—Å–ª–∞–≤—Å–∫–∏–π','–Ω–æ','–∫–∞–±—É–∫–∏','–º–∞—Å–∫–∞','–∫–∞—Ç–∞—Ä—Å–∏—Å'], facts:[
      '–ê–Ω—Ç–∏—á–Ω—ã–π —Ç–µ–∞—Ç—Ä —Å—Ç—Ä–µ–º–∏–ª—Å—è –∫ –∫–∞—Ç–∞—Ä—Å–∏—Å—É; –≤ –Ø–ø–æ–Ω–∏–∏ —Ç–µ–∞—Ç—Ä –ù–æ ‚Äî –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ã–π –∏ —Å–∏–º–≤–æ–ª–∏—á–Ω—ã–π.',
      '–°–∏—Å—Ç–µ–º–∞ –°—Ç–∞–Ω–∏—Å–ª–∞–≤—Å–∫–æ–≥–æ –ø–æ–≤–ª–∏—è–ª–∞ –Ω–∞ –∞–∫—Ç—ë—Ä—Å–∫—É—é —à–∫–æ–ª—É XX –≤–µ–∫–∞.'
    ], prompts:['–ß—Ç–æ —Ç–∞–∫–æ–µ ¬´—á–µ—Ç–≤—ë—Ä—Ç–∞—è —Å—Ç–µ–Ω–∞¬ª?','–ó–∞—á–µ–º –Ω—É–∂–Ω—ã –º–∞—Å–∫–∏ –≤ —Ç–µ–∞—Ç—Ä–µ –ù–æ?']},
    {topic:'–ö–∏–Ω–æ', keywords:['–∫–∏–Ω–æ','–º–æ–Ω—Ç–∞–∂','–Ω–µ–º–æ–µ –∫–∏–Ω–æ','–≥–æ–ª–ª–∏–≤—É–¥','–∞–≤—Ç–æ—Ä—Å–∫–æ–µ –∫–∏–Ω–æ','—Ç–∞—Ä–∫–æ–≤—Å–∫–∏–π','—Ñ–µ–ª–ª–∏–Ω–∏'], facts:[
      '–ú–æ–Ω—Ç–∞–∂ –ö—É–ª–µ—à–æ–≤–∞ –ø–æ–∫–∞–∑–∞–ª, –∫–∞–∫ —Å–º—ã—Å–ª —Ä–æ–∂–¥–∞–µ—Ç—Å—è –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ –∫–∞–¥—Ä–æ–≤.',
      '–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π –Ω–µ–æ—Ä–µ–∞–ª–∏–∑–º —Å—Ç—Ä–µ–º–∏–ª—Å—è –∫ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏, —Å–Ω–∏–º–∞—è –Ω–∞ —É–ª–∏—Ü–∞—Ö —Å –Ω–µ–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –∞–∫—Ç—ë—Ä–∞–º–∏.'
    ], prompts:['–ß–µ–º –∞–≤—Ç–æ—Ä—Å–∫–æ–µ –∫–∏–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –∂–∞–Ω—Ä–æ–≤–æ–≥–æ?','–ü–æ—á–µ–º—É –∫—Ä—É–ø–Ω—ã–π –ø–ª–∞–Ω —Ç–∞–∫ —Å–∏–ª—ë–Ω?']},
    {topic:'–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞', keywords:['–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞','–≥–æ—Ç–∏–∫–∞','–∫—É–ø–æ–ª–∞','–º–æ–¥–µ—Ä–Ω–∏–∑–º','–ª—ë –∫–æ—Ä–±—é–∑—å–µ','–æ—Ä–≥–∞–Ω–∏–∫–∞','—Ñ—Ä—ç–Ω–∫ –ª–ª–æ–π–¥ —Ä–∞–π—Ç'], facts:[
      '–ì–æ—Ç–∏–∫–∞ ‚Äî —Å—Ç—Ä–µ–ª—å—á–∞—Ç—ã–µ –∞—Ä–∫–∏, –∫–æ–Ω—Ç—Ä—Ñ–æ—Ä—Å—ã, –≤–∏—Ç—Ä–∞–∂–∏; —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö –∏ –∫ —Å–≤–µ—Ç—É.',
      '–ú–æ–¥–µ—Ä–Ω–∏–∑–º –ø—Ä–æ–≤–æ–∑–≥–ª–∞—Å–∏–ª ¬´—Ñ–æ—Ä–º–∞ —Å–ª–µ–¥—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏¬ª, –º–∏–Ω–∏–º–∞–ª–∏–∑–º –∏ –Ω–æ–≤—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.'
    ], prompts:['–ß—Ç–æ –æ—Ç–ª–∏—á–∞–µ—Ç –±–∞–∑–∏–ª–∏–∫—É –æ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö—Ä–∞–º–∞?','–ö–∞–∫ ¬´–ø—è—Ç—å –ø—É–Ω–∫—Ç–æ–≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã¬ª –≤–ª–∏—è–ª–∏ –Ω–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É?']},
    {topic:'–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', keywords:['–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞','—Ä–æ–º–∞–Ω','—ç–ø–æ—Å','–ø–æ—ç–∑–∏—è','–º–∏—Ñ','—Å–∏–º–≤–æ–ª–∏–∑–º','–º–∞–≥–∏—á–µ—Å–∫–∏–π —Ä–µ–∞–ª–∏–∑–º'], facts:[
      '–°–∏–º–≤–æ–ª–∏–∑–º –æ–ø–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ –Ω–∞–º—ë–∫ –∏ –º–Ω–æ–≥–æ–∑–Ω–∞—á–Ω–æ—Å—Ç—å –æ–±—Ä–∞–∑–∞.',
      '–ú–∞–≥–∏—á–µ—Å–∫–∏–π —Ä–µ–∞–ª–∏–∑–º —Å–æ–µ–¥–∏–Ω—è–µ—Ç –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–µ –∏ —á—É–¥–µ—Å–Ω–æ–µ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.'
    ], prompts:['–ß–µ–º —ç–ø–æ—Å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ä–æ–º–∞–Ω–∞?','–ö–∞–∫ —Ä–∏—Ç–º –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –ø–æ—ç–∑–∏–∏?']}
  ];

  // –®–∞–±–ª–æ–Ω—ã —Ä–µ–∂–∏–º–æ–≤
  const MODES = {
    normal:{name:'–û–±—ã—á–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫', style:(a)=>a},
    socratic:{name:'–°–æ–∫—Ä–∞—Ç', style: asSocratic},
    tutor:{name:'–£—á–∏—Ç–µ–ª—å', style: asTutor}
  };

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  const state = {
    mode:'normal',
    topic:null,
    name:null,
    turns:[],
    quiz:null,
    flags:{socratic:false, tutor:false, quiz:false}
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  renderChips();
  greet();

  function greet(){
    pushBot(`–ü—Ä–∏–≤–µ—Ç! –Ø —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ —Ç–µ–º–µ ¬´–ú–∏—Ä–æ–≤–∞—è –∏ —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞¬ª.\n\n–ú–æ–∂–µ–º –æ–±—Å—É–¥–∏—Ç—å —ç–ø–æ—Ö–∏ (–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å, –†–µ–Ω–µ—Å—Å–∞–Ω—Å, –ë–∞—Ä–æ–∫–∫–æ‚Ä¶), –≤–∏–¥—ã –∏—Å–∫—É—Å—Å—Ç–≤–∞ (–∂–∏–≤–æ–ø–∏—Å—å, –º—É–∑—ã–∫–∞, —Ç–µ–∞—Ç—Ä, –∫–∏–Ω–æ, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞) –∏–ª–∏ —Ç—Ä–∞–¥–∏—Ü–∏–∏ —Ä–∞–∑–Ω—ã—Ö –Ω–∞—Ä–æ–¥–æ–≤.\n\n–°–æ–≤–µ—Ç—ã: –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã: \n- <span class="kbd">/topic</span> –†–µ–Ω–µ—Å—Å–∞–Ω—Å ‚Äî –≤—ã–±—Ä–∞—Ç—å —Ç–µ–º—É;\n- <span class="kbd">/mode</span> –°–æ–∫—Ä–∞—Ç | –£—á–∏—Ç–µ–ª—å | –û–±—ã—á–Ω—ã–π;\n- <span class="kbd">/quiz</span> ‚Äî –º–∏–Ω–∏‚Äë–≤–∏–∫—Ç–æ—Ä–∏–Ω–∞;\n- <span class="kbd">/help</span> ‚Äî —Å–ø—Ä–∞–≤–∫–∞.`);
  }

  function renderChips(){
    TOPICS.forEach(t=>{
      const el=document.createElement('button');
      el.className='chip'; el.textContent=t; el.onclick=()=>setTopic(t,true);
      chipsEl.appendChild(el);
    })
  }

  function setTopic(t, announce=false){
    state.topic=t; statusEl.textContent = `–¢–µ–º–∞: ${t}`;
    if(announce) pushBot(`–û—Ç–ª–∏—á–Ω–æ! –°—É–∑–∏–º —Ä–∞–∑–≥–æ–≤–æ—Ä: ¬´${t}¬ª. –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í–∏–∫—Ç–æ—Ä–∏–Ω–∞¬ª.`);
  }

  function pushUser(text){
    const card = document.createElement('div'); card.className='msg';
    card.innerHTML = `<div class="avatar">üßë</div><div><div class="bubble user">${escapeHtml(text)}</div><div class="meta">–í—ã</div></div>`;
    feed.appendChild(card); feed.scrollTop = feed.scrollHeight;
  }

  function pushBot(html){
    const card = document.createElement('div'); card.className='msg';
    const id = 'b'+Math.random().toString(36).slice(2);
    card.innerHTML = `<div class="avatar bot">üé≠</div><div><div class="bubble bot" id="${id}"><div class="typing"><span></span><span></span><span></span></div></div><div class="meta">–ë–æ—Ç</div></div>`;
    feed.appendChild(card); feed.scrollTop = feed.scrollHeight;
    setTimeout(()=>{ document.getElementById(id).innerHTML = html; feed.scrollTop = feed.scrollHeight; }, 450 + Math.random()*500);
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  }

  function findTopicByText(text){
    const low=text.toLowerCase();
    // –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞)
    const m = low.match(/–º–µ–Ω—è\s+–∑–æ–≤—É—Ç\s+([a-z–∞-—è—ë\- ]{2,})/i);
    if(m){ state.name = m[1].trim().split(' ')[0]; }

    // –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º—ã
    if(state.topic) return KB.find(k=>k.topic===state.topic);
    // –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    return KB.find(k=>k.keywords.some(w=>low.includes(w))) || null;
  }

  function genAnswer(text){
    // –∫–æ–º–∞–Ω–¥—ã
    const trimmed = text.trim();
    if(/^\/help/.test(trimmed)) return helpMsg();
    if(/^\/reset/.test(trimmed)) {reset(); return null}
    if(/^\/topic\s+/i.test(trimmed)) { const t=trimmed.replace(/^\/topic\s+/i,'').trim(); if(t){ setTopic(t,true); } else { pushBot('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ /topic. –ü—Ä–∏–º–µ—Ä: <span class="kbd">/topic –†–µ–Ω–µ—Å—Å–∞–Ω—Å</span>'); } return null }
    if(/^\/mode\s*/i.test(trimmed)) { return switchMode(trimmed.replace(/^\/mode\s*/i,'')); }
    if(/^\/quiz/i.test(trimmed)) { startQuiz(); return null }

    const kb = findTopicByText(text);
    const name = state.name ? `, ${capitalize(state.name)}` : '';

    if(cbQuiz.checked || state.flags.quiz){ ensureQuizDeck(kb); return answerQuiz(text); }

    if(!kb){
      const follow = suggestTopics(text);
      return `–Ø –ø–æ–∫–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª —Ç–µ–º—É${name}. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ —á—É—Ç—å —Ç–æ—á–Ω–µ–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª.\n\n–í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ${TOPICS.slice(0,8).join(', ')}‚Ä¶` + follow;
    }

    const fact = pick(kb.facts);
    const prompt = pick(kb.prompts);

    let answer = `<div>${fact}</div>`;
    if(cbTutor.checked || state.flags.tutor){
      answer += `<div class="notice" style="margin-top:8px">–ó–∞–¥–∞–Ω–∏–µ: ${miniTaskFor(kb.topic)}</div>`;
    }
    if(cbSocratic.checked || state.flags.socratic){
      answer += asSocratic(`–ö–∞–∫ –≤—ã —ç—Ç–æ –ø–æ–Ω–∏–º–∞–µ—Ç–µ${name}? ${prompt}`);
    } else {
      answer += `<div style="margin-top:8px">–í–æ–ø—Ä–æ—Å –∫ –≤–∞–º${name}: ${prompt}</div>`;
    }
    return answer;
  }

  function helpMsg(){
    return `–ö–æ–º–∞–Ω–¥—ã:\n‚Ä¢ <span class="kbd">/topic</span> &lt;—Ç–µ–º–∞&gt; ‚Äî –≤—ã–±—Ä–∞—Ç—å —Ç–µ–º—É (–Ω–∞–ø—Ä. /topic –†–µ–Ω–µ—Å—Å–∞–Ω—Å)\n‚Ä¢ <span class="kbd">/mode</span> –°–æ–∫—Ä–∞—Ç | –£—á–∏—Ç–µ–ª—å | –û–±—ã—á–Ω—ã–π ‚Äî —Å—Ç–∏–ª—å –±–µ—Å–µ–¥—ã\n‚Ä¢ <span class="kbd">/quiz</span> ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–Ω–∞—á–∞—Ç—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø–æ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ\n‚Ä¢ <span class="kbd">/reset</span> ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥\n\n–°–æ–≤–µ—Ç: —É–∫–∞–∂–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å (–Ω–∞–ø—Ä. ¬´–∫–∞–∫ –∏–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏—Å—Ç—ã –ø–∏—Å–∞–ª–∏ —Å–≤–µ—Ç?¬ª).`;
  }

  function switchMode(arg){
    const a = arg.trim().toLowerCase();
    if(a.startsWith('—Å–æ–∫')){ state.flags.socratic=true; state.flags.tutor=false; pushBot('–†–µ–∂–∏–º: –°–æ–∫—Ä–∞—Ç–∏—á–µ—Å–∫–∏–π. –Ø –±—É–¥—É —á–∞—â–µ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã.'); return null }
    if(a.startsWith('—É—á–∏')){ state.flags.tutor=true; state.flags.socratic=false; pushBot('–†–µ–∂–∏–º: –£—á–∏—Ç–µ–ª—å. –Ø –¥–æ–±–∞–≤–ª—è—é –ø–æ—è—Å–Ω–µ–Ω–∏—è –∏ –∑–∞–¥–∞–Ω–∏—è.'); return null }
    if(a.startsWith('–æ–±—ã') || a==='') { state.flags.tutor=false; state.flags.socratic=false; pushBot('–†–µ–∂–∏–º: –û–±—ã—á–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫.'); return null }
    return `–ù–µ —É–∑–Ω–∞–ª —Ä–µ–∂–∏–º. –î–æ—Å—Ç—É–ø–Ω—ã: –û–±—ã—á–Ω—ã–π, –°–æ–∫—Ä–∞—Ç, –£—á–∏—Ç–µ–ª—å.`;
  }

  function asSocratic(text){
    return `<div style="margin-top:8px" class="notice">–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –≤–æ–ø—Ä–æ—Å–∞–º–∏: ${text}</div>`
  }

  function asTutor(answer){
    return answer + `<div class="notice" style="margin-top:8px">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä –∏–∑ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è.</div>`
  }

  function miniTaskFor(topic){
    const tasks = {
      '–ê–Ω—Ç–∏—á–Ω–æ—Å—Ç—å':'–ù–∞–π–¥–∏—Ç–µ 2 –æ—Ç–ª–∏—á–∏—è –¥–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –∏ –∏–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ—Ä–¥–µ—Ä–æ–≤ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö.',
      '–†–µ–Ω–µ—Å—Å–∞–Ω—Å':'–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏–Ω–µ–π–Ω–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–µ.',
      '–ë–∞—Ä–æ–∫–∫–æ':'–ü–æ–¥–±–µ—Ä–∏—Ç–µ –ø—Ä–∏–º–µ—Ä ¬´—Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–æ–≥–æ¬ª —Å–≤–µ—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏.',
      '–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º':'–°–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ –Ω–∞ —É–ª–∏—Ü–µ –∏ –æ—Ç–º–µ—Ç—å—Ç–µ, –∫–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è —Ü–≤–µ—Ç –ø—Ä–∏ –æ—Å–≤–µ—â–µ–Ω–∏–∏.',
      '–ê–≤–∞–Ω–≥–∞—Ä–¥':'–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç, —Å–≤–µ–¥—è –µ–≥–æ –∫ –ø—Ä–æ—Å—Ç—ã–º —Ñ–æ—Ä–º–∞–º.',
      '–ú—É–∑—ã–∫–∞':'–°–ª—É—à–∞—è —Å–∏–º—Ñ–æ–Ω–∏—é, –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —ç–∫—Å–ø–æ–∑–∏—Ü–∏—é –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É.',
      '–¢–µ–∞—Ç—Ä':'–ù–∞–±–ª—é–¥–∞—è —Å—Ü–µ–Ω—É, –æ—Ç–º–µ—Ç—å—Ç–µ ¬´—á–µ—Ç–≤—ë—Ä—Ç—É—é —Å—Ç–µ–Ω—É¬ª.',
      '–ö–∏–Ω–æ':'–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ü–µ–Ω—É, –≥–¥–µ –º–æ–Ω—Ç–∞–∂ —É—Å–∏–ª–∏–≤–∞–µ—Ç —Å–º—ã—Å–ª.',
      '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞':'–ù–∞–π–¥–∏—Ç–µ –≤ –≥–æ—Ä–æ–¥–µ –ø—Ä–∏–º–µ—Ä –º–æ–¥–µ—Ä–Ω–∏–∑–º–∞ –∏–ª–∏ –≥–æ—Ç–∏–∫–∏.',
      '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞':'–°—Ä–∞–≤–Ω–∏—Ç–µ —Å–∏–º–≤–æ–ª –∏ –º–µ—Ç–∞—Ñ–æ—Ä—É –≤ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–∏.'
    };
    return tasks[topic] || '–ö–æ—Ä–æ—Ç–∫–æ –ø–µ—Ä–µ—Å–∫–∞–∂–∏—Ç–µ –∏–¥–µ—é —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏.';
  }

  function suggestTopics(text){
    const low = text.toLowerCase();
    const hits = KB.filter(k => k.keywords.some(w=> low.includes(w))).map(k=>k.topic);
    if(hits.length){
      return `\n\n–ü–æ—Ö–æ–∂–µ, –≤—ã –∏–º–µ–µ—Ç–µ –≤ –≤–∏–¥—É: ${[...new Set(hits)].join(', ')}.`;
    }
    return '';
  }

  function ensureQuizDeck(kb){
    if(state.quiz && state.quiz.active) return;
    const base = (kb||KB[0]);
    const pool = [
      {q:'–ß—Ç–æ –¥–ª—è –∏–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º–∞ –Ω–∞–∏–±–æ–ª–µ–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ?', options:['–õ–∏–Ω–µ–π–Ω–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞','–ü–ª–µ–Ω—ç—Ä –∏ –∏–∑–º–µ–Ω—á–∏–≤—ã–π —Å–≤–µ—Ç','–ú–∏—Ñ–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å—é–∂–µ—Ç—ã'], correct:1, why:'–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏—Å—Ç—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –∏ —Å–≤–µ—Ç.'},
      {q:'–ö—Ç–æ –∏–∑ —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤ ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –í—ã—Å–æ–∫–æ–≥–æ –†–µ–Ω–µ—Å—Å–∞–Ω—Å–∞?', options:['–†–∞—Ñ–∞—ç–ª—å','–†–æ–¥–µ–Ω','–ú–∏—Ä–æ'], correct:0, why:'–†–∞—Ñ–∞—ç–ª—å –°–∞–Ω—Ç–∏ ‚Äî –∫–ª—é—á–µ–≤–∞—è —Ñ–∏–≥—É—Ä–∞ –í—ã—Å–æ–∫–æ–≥–æ –†–µ–Ω–µ—Å—Å–∞–Ω—Å–∞.'},
      {q:'–ö–∞–∫–æ–π –ø—Ä–∏–Ω—Ü–∏–ø –±–ª–∏–∑–æ–∫ –º–æ–¥–µ—Ä–Ω–∏–∑–º—É –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ?', options:['¬´–§–æ—Ä–º–∞ —Å–ª–µ–¥—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏¬ª','¬´–ò—Å–∫—É—Å—Å—Ç–≤–æ —Ä–∞–¥–∏ –∏—Å–∫—É—Å—Å—Ç–≤–∞¬ª','¬´–ù–∞–∑–∞–¥ –∫ –∫–ª–∞—Å—Å–∏—Ü–∏–∑–º—É¬ª'], correct:0, why:'–ú–æ–¥–µ—Ä–Ω–∏–∑–º –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–ª —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å.'},
      {q:'–ö–∞–∫–æ–π —Ç–µ–∞—Ç—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–∞—Å–∫–∏ –∏ –º–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ã–π —Ä–∏—Ç–º?', options:['–ö–∞–±–∞—Ä–µ','–ù–æ','–ö–æ–º–µ–¥–∏—è –¥–µ–ª—å –∞—Ä—Ç–µ'], correct:1, why:'–¢–µ–∞—Ç—Ä –ù–æ ‚Äî —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π —è–ø–æ–Ω—Å–∫–∏–π —Ç–µ–∞—Ç—Ä —Å –º–∞—Å–∫–∞–º–∏.'},
      {q:'–ß—Ç–æ –∏–∑—É—á–∞–µ—Ç —Å—É–ø—Ä–µ–º–∞—Ç–∏–∑–º?', options:['–ß–∏—Å—Ç–æ–µ —á—É–≤—Å—Ç–≤–æ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—ã –∏ —Ü–≤–µ—Ç','–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Ä–µ–∞–ª–∏–∑–º','–°–æ—Ü–∏–∞–ª—å–Ω—É—é —Å–∞—Ç–∏—Ä—É'], correct:0, why:'–°—É–ø—Ä–µ–º–∞—Ç–∏–∑–º ‚Äî –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ –ú–∞–ª–µ–≤–∏—á–∞.'}
    ];
    shuffle(pool);
    state.quiz = {active:true, score:0, total:0, pool, current:null};
    askNextQuiz();
  }

  function startQuiz(){
    state.flags.quiz = !state.flags.quiz;
    if(state.flags.quiz){
      pushBot('–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞. –ü–æ–µ—Ö–∞–ª–∏!');
      ensureQuizDeck(findTopicByText(state.topic||''));
    } else {
      pushBot('–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –±–µ—Å–µ–¥–µ.');
      state.quiz=null;
    }
  }

  function askNextQuiz(){
    const q = state.quiz.pool.pop();
    if(!q){
      pushBot(`<div class="success">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°—á—ë—Ç: ${state.quiz.score}/${state.quiz.total}</div>`);
      state.flags.quiz=false; state.quiz=null; return;
    }
    state.quiz.current=q; state.quiz.total++;
    const opts = q.options.map((o,i)=>`<button class="opt" data-i="${i}">${escapeHtml(o)}</button>`).join('');
    pushBot(`<div><strong>–í–æ–ø—Ä–æ—Å ${state.quiz.total}:</strong> ${escapeHtml(q.q)}</div><div class="optrow" data-quiz="1">${opts}</div>`);
  }

  function answerQuiz(text){
    // –ø–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å –Ω–æ–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const num = parseInt(text.trim(),10);
    if(Number.isInteger(num)){
      return grade(num-1);
    }
    // –∏–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –±–µ—Å–µ–¥—É –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º
    return `–ú—ã –≤ —Ä–µ–∂–∏–º–µ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (1, 2, 3).`;
  }

  function grade(i){
    const q = state.quiz.current;
    if(!q) return '–ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å‚Ä¶';
    let html='';
    if(i===q.correct){
      state.quiz.score++; html = `<div class="success">–í–µ—Ä–Ω–æ! ${escapeHtml(q.why)}</div>`;
    } else {
      html = `<div class="danger">–ù–µ —Å–æ–≤—Å–µ–º. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${q.correct+1}. ${escapeHtml(q.why)}</div>`;
    }
    pushBot(html);
    askNextQuiz();
    return null;
  }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }
  function capitalize(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s }

  function reset(){
    feed.innerHTML=''; state.topic=null; state.turns=[]; state.flags={socratic:false,tutor:false,quiz:false}; state.quiz=null; statusEl.textContent='–ì–æ—Ç–æ–≤ –∫ –±–µ—Å–µ–¥–µ';
    pushBot('–î–∏–∞–ª–æ–≥ —Å–±—Ä–æ—à–µ–Ω. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å.');
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
  feed.addEventListener('click', (e)=>{
    const btn = e.target.closest('.opt');
    if(btn && btn.parentElement?.dataset.quiz){
      const i = parseInt(btn.dataset.i,10); grade(i);
    }
  });

  // –≠–∫—Å–ø–æ—Ä—Ç –±–µ—Å–µ–¥—ã
  btnExport.addEventListener('click', ()=>{
    const lines = Array.from(feed.querySelectorAll('.msg')).map(msg=>{
      const isBot = msg.querySelector('.avatar')?.classList.contains('bot');
      const text = msg.querySelector('.bubble')?.innerText || '';
      return (isBot? '–ë–æ—Ç: ':'–í—ã: ') + text.replace(/\s+$/,'');
    });
    const blob = new Blob([lines.join('\n\n')],{type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='dialog-kultura.txt'; a.click(); URL.revokeObjectURL(url);
  });

  btnReset.addEventListener('click', reset);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  sendBtn.addEventListener('click', ()=>{
    const text = input.value.trim(); if(!text) return; pushUser(text);
    const resp = genAnswer(text); if(resp){ pushBot(resp) }
    input.value=''; input.focus();
  });
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
  });
})();
</script>
</body>
</html>
